libname mdb "/efs-MAIO/Team/promo_opt/MktMixPP/2024 Planning/G9/output/out_sas_data_sets/DMA/MDB";
libname INTER "/efs-MAIO/Team/promo_opt/MktMixPP/2024 Planning/G9/output/out_sas_data_sets/DMA/INTER";
libname MODEL "/efs-MAIO/Team/promo_opt/MktMixPP/2024 Planning/G9/output/out_sas_data_sets/DMA/MODEL";

OPTIONS COMPRESS=YES NOLABEL NOCENTER ERROR=1 MACROGEN SYMBOLGEN ;
PROC DATASETS LIBRARY = WORK NOLIST KILL;
RUN;QUIT;


data s;
set MODEL.FT_ADS_G9_DMA_MDB;
WHERE DMANAME <> 'ZZUNASSIGNED';
run;


proc sort data=s; by dmaname yearmo;
run;


proc standard data=s mean=0 
out= demean_data_2;
by dmaname;                    *Change this to party_id,dmaname,zip3 as applicable;
var   npp: hcp: hcc:  details:  
adol: adt:  total:  ;  *Demean all the variables used in the model including the dependent variable;
run;


data model.FT_ADS_G9_dma_adol_MDB_DM_2;
set demean_data_2;
run;

data model_data;
set  MODEL.FT_ADS_G9_DMA_MDB;
WHERE DMANAME <> 'ZZUNASSIGNED';
run;


%MACRO ols_regression_impact_ridge_dm(cnt, data,model_data, LAMBDA, DEP_VAR, IND_VAR);

DATA INTERMEDIATE;
SET &data. (KEEP=&DEP_VAR. &IND_VAR. YEARMO dmaname) nobs=degfreedom;   *change it to dmaname/party_id/zip3 as applicable;
RUN;

ODS OUTPUT PARAMETERESTIMATES=PEST;

proc reg data= INTERMEDIATE outvif outseb plots(only)=ridge(unpack VIFaxis=log) 
		outest=temp_ridge ridge= &LAMBDA.;
model &DEP_VAR.= &IND_VAR.
		/* M1-M11 */
		/* BUDGET_CUT */ /VIF;
	plot / ridgeplot nomodel nostat;
	run;
quit;

proc transpose data = temp_ridge out=temp_ridge_t;run;

proc sql ;
create table PEST as
select Model, Dependent , Variable,
DF, Estimate, StdErr, tValue, Probt, VarianceInflation,
key
from
(
select "MODEL1" as Model, "&DEP_VAR." as Dependent , _NAME_ as Variable,   /*change to whatever dependent variable required like hcp_grail_nrx etc*/
"1" as DF, COL4 as Estimate, COL5 as StdErr, 0 as tValue, 0 as Probt, COL3 as VarianceInflation,
101 as key,
monotonic()   AS RowNumber, count(*) as rows
from temp_ridge_t
having RowNumber >3 and RowNumber<rows) as A
;
run;

DATA TEMP&cnt.;
SET PEST;
length key 6.;
key=&cnt.;
RUN;

proc means data=&model_data. sum nway nonobs maxdec=2 noprint;
var _numeric_;
output out=col_sums sum=;
run;

data col_sums;
set col_sums;
Rename _Freq_=Intercept;
run;

proc transpose data=col_sums out=col_sums_t;
run;

data sums_w_sales_temp (drop=_name_);
length variable $32;
set col_sums_t;
Variable=_name_;
rename col1=Total_Activity;
run;

proc sql;
create table sums_w_sales as select *, (select sum(Total_Activity) from
sums_w_sales_temp where variable="&DEP_VAR.") as Total_sales from          /*change to whatever dependent variable required like hcp_grail_nrx etc*/
sums_w_sales_temp;
quit;

proc sort data=sums_w_sales;
by variable;
run;

data results (drop=Model Dependent key);
set temp&cnt.;
run;

proc means data=&model_data. sum nway nonobs maxdec=2 noprint;
where RTIME <= 13 and RTIME > 1;
var _numeric_;
output out=col_sums_annual sum=;
run;

data col_sums_annual;
set col_sums_annual;
Rename _Freq_=Intercept;
run;

proc transpose data=col_sums_annual out=col_sums_annual_t;
run;

data sums_w_sales_annual_temp (drop=_name_);
length variable $32;
set col_sums_annual_t;
Variable=_name_;
rename col1=Annual_Activity12;
run;

proc sql;
create table sums_w_sales_annual as select *, (select sum(Annual_Activity12)
from sums_w_sales_annual_temp where variable="&DEP_VAR.") as Annual_sales       /*change to whatever dependent variable required like hcp_grail_nrx etc*/
from sums_w_sales_annual_temp;
quit;

proc sort data=sums_w_sales_annual;
by variable;
run;

proc sort data=results;
by variable;
run;

proc sort data=sums_w_sales;
by variable;
run;

proc sort data=sums_w_sales_annual;
by variable;
run;

proc sql;
create table result_w_colsum as select * from results as a left join
sums_w_sales as b on a.variable=b.variable left join sums_w_sales_annual as
c on a.variable=c.variable;
quit;

proc sql noprint;
select count(*) into :degfreedom
from INTERMEDIATE;
run;

data p_impactable;
set result_w_colsum;
tValue=Estimate/StdErr;
Probt=(1-probt(abs(tValue),&degfreedom.))*2;
Total_percentage=((estimate*Total_Activity)/Total_sales);
Annual_percentage=((estimate*Annual_Activity12)/Annual_sales);
drop _label_;
keep Variable DF Estimate StdErr tValue	Probt VarianceInflation	Total_Activity Total_sales Annual_Activity12 Annual_sales	Total_percentage Annual_percentage;
run;

PROC PRINT DATA=p_impactable;
format estimate 15.8;
RUN;

%MEND;


/* Step 1 */

*RIDGE Model run with lambda value as 0.081;
%ols_regression_impact_ridge_dm(101,model.FT_ADS_G9_dma_adol_MDB_DM_2,model_data, 0.1,total_doses,
					hcc_tv_adol_mrk_grps_f255440_rt4
					hcc_osrch_sessions30_rt8
					hcp_osrch_sessions
					hcp_disp_adol_imp90
					hcp_psrch_adol_clk
					npp_adt_eng_rt4
					npp_adol_eng
					hcp_field_adol_eng75
					hcp_totdet_mmf
					total_doses_lag
					total_doses_slag
					workdays
					RTIME
					M1-M11
					ADOL_PP_HCP
					ADOL_PP_HCC);
					
					
					
/* 		0.6586			 */
					
proc export data =p_impactable  outfile= "/efs-MAIO/Team/promo_opt/MktMixPP/2024 Planning/G9/output/out_data/DMA/adol_2" dbms= xlsx replace;
sheet = '4.1_dm_s1_0.1';
run;


Data d_step_2;
set model.FT_ADS_G9_dma_adol_MDB_DM_2;
 total_doses= total_doses-(26.20434354*hcc_tv_adol_mrk_grps_f255440_RT4);
run;

Data step_2;
set model_data;
 total_doses= total_doses-(26.20434354*hcc_tv_adol_mrk_grps_f255440_RT4);
/* (17.73950629*hcc_tv_adol_mrk_grps_f255440_RT5); */
run;


/* Step 2 */

/* using oter measuring variables to control social */
*RIDGE Model run with lambda value as 0.081;
%ols_regression_impact_ridge_dm(101,d_step_2,step_2, 0.095,total_doses,
					hcc_audio_adol_imp_rt4
					HCC_DISP_ADT_IMP_DCM_COR
					hcc_olv_adol_imp_rt4
					hcc_psrch_adol_clk
					hcc_soc_adol_imp30
				    hcc_stv_adol_imp90
					hcc_osrch_sessions_rt4
					hcp_osrch_sessions75
					hcp_disp_adol_imp90
					hcp_psrch_adol_clk90
					npp_adt_eng
					npp_adol_eng90
					hcp_field_adol_eng
					hcp_totdet_mmf
					total_doses_lag
					total_doses_slag
					workdays
					RTIME
					M1-M11
					ADOL_PP_HCP
					ADOL_PP_HCC);
					
/* if we use adstock above 30 then it is turning negative and applying transformation on 40 will make it even  */
/* more negative and applying transformation on adstock 30 and below will increase.			 */
					
/* 		0.6622			 */

proc export data =p_impactable  outfile= "/efs-MAIO/Team/promo_opt/MktMixPP/2024 Planning/G9/output/out_data/DMA/adol_2" dbms= xlsx replace;
sheet = '4_dm_s2_0.0.95';
run;
					
proc export data =p_impactable  outfile= "/efs-MAIO/Team/promo_opt/MktMixPP/2024 Planning/G9/output/out_data/DMA/adol_2" dbms= xlsx replace;
sheet = '4_dm_s2_0.12';
run;

Data d_step_3;
set d_step_2;
 total_doses= total_doses-(0.00019563*hcc_soc_adol_imp30);
run;

Data step_3;
set step_2;
 total_doses= total_doses-(0.00019563*hcc_soc_adol_imp30);
run;

/* Step 3 */

*RIDGE Model run with lambda value as 0.081;
%ols_regression_impact_ridge_dm(101,d_step_3,step_3, 0.06,total_doses,
					HCC_DISP_ADT_IMP_DCM_COR30
					hcc_olv_adol_imp
					hcc_osrch_sessions30_rt8
					hcp_osrch_sessions
					hcp_disp_adol_imp90
					hcp_psrch_adol_clk
					npp_adt_eng_rt4
					npp_adol_eng
					hcp_field_adol_eng75
					hcp_totdet_mmf
					total_doses_lag
					total_doses_slag
					workdays
					RTIME
					M1-M11
					ADOL_PP_HCP
					ADOL_PP_HCC);
					
					
proc export data =p_impactable  outfile= "/efs-MAIO/Team/promo_opt/MktMixPP/2024 Planning/G9/output/out_data/DMA/adol_2" dbms= xlsx replace;
sheet = '4_dm_s3_0.06';
run;

Data d_step_4;
set d_step_3;
 total_doses= total_doses-(0.00011648*HCC_DISP_ADT_IMP_DCM_COR30 + 0.00298911*hcc_olv_adol_imp);
run;

Data step_4;
set step_3;
 total_doses= total_doses-(0.00011648*HCC_DISP_ADT_IMP_DCM_COR30 + 0.00298911*hcc_olv_adol_imp);
/*  (0.00014348*HCC_DISP_ADT_IMP_DCM_COR10 + 0.00374060*hcc_olv_adol_imp); */
run;

/* Step 4 */

*RIDGE Model run with lambda value as 0.081;
%ols_regression_impact_ridge_dm(101,d_step_4,step_4, 0.075,total_doses,
					hcc_audio_adol_imp40_rt8
					hcc_psrch_adol_clk
				    hcc_stv_adol_imp
					hcc_osrch_sessions30_rt8
					hcp_osrch_sessions
					hcp_disp_adol_imp90
					hcp_psrch_adol_clk
					npp_adt_eng_rt4
					npp_adol_eng
					hcp_field_adol_eng75
					hcp_totdet_mmf
					total_doses_lag
					total_doses_slag
					workdays
					RTIME
					M1-M11
					ADOL_PP_HCP
					ADOL_PP_HCC);
					
					
proc export data =p_impactable  outfile= "/efs-MAIO/Team/promo_opt/MktMixPP/2024 Planning/G9/output/out_data/DMA/adol_2" dbms= xlsx replace;
sheet = '4_dm_s4_0.075';
run;